"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[637],{64792:function(e,n,t){t.r(n),t.d(n,{default:function(){return ce}});var i=t(90228),a=t.n(i),r=t(87999),o=t.n(r),l=t(48305),s=t.n(l),c=t(26068),u=t.n(c),d=t(82092),p=t.n(d),f=t(15558),h=t.n(f),v=t(45889),m=t(37956),x=t(70725),g=t(73264),y=t(912),j=t(31331),Z=t(64684),w=t(21621),b=t(74230),k=t(22825),S=t(60247),C=t(77621),I=t(45144),z=t(37348),R=t(10754),P=t(50959),E=t(38653),K=t(67825),L=t.n(K),T=t(14471),O=t(37714),H=t(49434),N=t(82993),q=t(35363),A=t(39158),_=t(29328),F=t(52296),V=t(54381),D=t(11527),M=function(e){var n=e.actionRef,t=e.selectedCallback,i=e.checkType,r=void 0===i?"checkbox":i,l=(0,P.useState)(!1),c=s()(l,2),u=c[0],d=c[1],p=(0,P.useState)([]),f=s()(p,2),h=f[0],m=f[1],j=(0,P.useState)([]),w=s()(j,2),b=w[0],k=w[1],S=(0,P.useState)(),C=s()(S,2),I=C[0],z=C[1],E=(0,P.useState)([]),K=s()(E,2),L=K[0],O=K[1],N=(0,P.useState)(),M=s()(N,2),Y=M[0],J=M[1],U=(0,P.useState)(!1),B=s()(U,2),G=B[0],Q=B[1],W=(0,P.useState)([]),X=s()(W,2),$=X[0],ee=X[1],ne=(0,P.useState)([]),te=s()(ne,2),ie=te[0],ae=te[1],re=P.useRef(null),oe=(0,v.Z)(H.Mg,{manual:!0,onSuccess:function(e){O((null==e?void 0:e.data)||[])}}).run;return P.useImperativeHandle(n,(function(){return{open:function(e){d(!0),J(e.params||{}),ee(e.selected||[]),oe()}}})),(0,D.jsx)(D.Fragment,{children:(0,D.jsx)(q.Z,{width:1200,title:"成员选择",destroyOnClose:!0,maskClosable:!1,confirmLoading:G,open:u,footer:(0,D.jsxs)(D.Fragment,{children:[(0,D.jsx)(Z.ZP,{type:"default",onClick:function(){d(!1)},children:"保存"}),(0,D.jsx)(Z.ZP,{type:"primary",loading:G,onClick:o()(a()().mark((function e(){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Q(!0),t(ie,Y),Q(!1),d(!1);case 4:case"end":return e.stop()}}),e)}))),children:"保存"})]}),onCancel:function(){return d(!1)},afterClose:function(){Q(!1),ee([]),ae([]),J(void 0),k([]),m([])},children:(0,D.jsxs)(x.Z,{children:[(0,D.jsx)(g.Z,{span:6,children:(0,D.jsx)(y.Z,{size:"small",title:"组织部门",styles:{body:{minHeight:"60vh"}},children:(0,D.jsx)(R.Z,{showLine:!0,blockNode:!0,defaultExpandAll:!0,autoExpandParent:!0,treeData:L||[],switcherIcon:function(e){return null!=e&&e.expanded?(0,D.jsx)(_.Z,{style:{fontSize:20}}):(0,D.jsx)(F.Z,{style:{fontSize:20}})},selectedKeys:h,expandedKeys:b,onExpand:function(e){return k(e)},fieldNames:{title:"name",key:"uuid",children:"children"},onSelect:function(){var e=o()(a()().mark((function e(n,t){var i,r;return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.selected,r=t.node,m(n),i&&z(r);case 3:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}()})})}),(0,D.jsx)(g.Z,{span:9,style:{paddingLeft:12},children:(0,D.jsx)(y.Z,{size:"small",title:"组织成员",styles:{body:{minHeight:"60vh"}},children:(0,D.jsx)(V.Rs,{size:"small",search:!1,rowKey:"serial",actionRef:re,tableAlertRender:!1,tableStyle:{padding:0},cardProps:{bodyStyle:{padding:0}},params:{departmentId:null==I?void 0:I.id},request:function(e){return(0,H.vh)({where:e})},metas:{title:{dataIndex:"name",render:function(e,n){return n.position?"".concat(n.name,"[").concat(n.position,"]"):n.name}}},rowSelection:{type:r,selectedRowKeys:$,preserveSelectedRowKeys:!0,onChange:function(e,n){ee(e),ae(n)}}})})}),(0,D.jsx)(g.Z,{span:9,style:{paddingLeft:12},children:(0,D.jsx)(y.Z,{size:"small",title:"已选成员",styles:{body:{minHeight:"60vh"}},children:(0,D.jsx)(T.Z,{wrap:!0,children:null==ie?void 0:ie.map((function(e){return(0,D.jsx)(A.Z,{closable:!0,color:"processing",onClose:function(){ee((function(n){return n.filter((function(n){return n!==e.serial}))})),ae((function(n){return n.filter((function(n){return n.serial!==e.serial}))}))},children:null==e?void 0:e.name},null==e?void 0:e.serial)}))})})})]})})})},Y=["value","onChange"],J=function(e){var n=e.value,t=e.onChange,i=L()(e,Y),a=P.useState([]),r=s()(a,2),o=r[0],l=r[1],c=P.useRef(null),d=(0,v.Z)(H.oO,{onSuccess:function(e){l(e.data||[])}}).loading;return(0,D.jsxs)(D.Fragment,{children:[(0,D.jsxs)(T.Z.Compact,{block:!0,children:[(0,D.jsx)(I.default,u()({allowClear:!0,showSearch:!0,value:n,loading:d,placeholder:"请选择成员",style:{width:"100%"},filterOption:function(e,n){var t,i;return(null!==(t=null==n||null===(i=n.label)||void 0===i?void 0:i.toString())&&void 0!==t?t:"").toLowerCase().includes(e.toLowerCase())},options:o.map((function(e){return u()(u()({},e),{},{label:e.name,value:e.serial})})),onChange:function(e,n){null==t||t(e,n)},optionRender:function(e){var n=e.data;return(0,D.jsxs)(T.Z,{children:[(0,D.jsx)(O.C,{src:n.avatar,children:n.label}),(0,D.jsx)(b.Z.Text,{strong:!0,children:n.label})]})}},i)),(0,D.jsx)(Z.ZP,{icon:(0,D.jsx)(N.Z,{}),onClick:function(){var e;null===(e=c.current)||void 0===e||e.open({selected:n})}})]}),(0,D.jsx)(M,{actionRef:c,selectedCallback:function(e){e&&(null==t||t(null==e?void 0:e.map((function(e){return e.serial})),e))}})]})},U=t(81796),B=t(7733),G=t(28213),Q=t(33600),W=["id"];function X(e,n){return $.apply(this,arguments)}function $(){return($=o()(a()().mark((function e(n,t){var i,r;return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.id,r=L()(n,W),e.abrupt("return",(0,Q.request)("/api/organizations/role/".concat(i),u()({method:"DELETE",params:u()({},r)},t||{})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ee(e,n){return ne.apply(this,arguments)}function ne(){return(ne=o()(a()().mark((function e(n,t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,Q.request)("/api/organizations/role/members/set",u()({method:"POST",headers:{"Content-Type":"application/json"},data:n},t||{})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function te(e,n){return ie.apply(this,arguments)}function ie(){return(ie=o()(a()().mark((function e(n,t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(0,Q.request)("/api/organizations/role/resources/set",u()({method:"POST",headers:{"Content-Type":"application/json"},data:n},t||{})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ae=t(73115),re=t(5135),oe=t(70346),le=t(41778),se=function(e,n){var t={},i=function e(n,i){Object.assign(t,p()({},n,t[n]?[].concat(h()(t[n]),h()(i.map((function(e){return e.id})))):i.map((function(e){return e.id})))),i.forEach((function(t){t.children&&t.children.length&&e(n,t.children)}))};return function e(t){t.forEach((function(t){n.find((function(e){return e.id===t.id}))&&i(t.id.toString(),t.children||[]),t.children&&e(t.children)}))}(e),n.map((function(e){var i;return u()(u()({},e),{},{isHalf:(null===(i=t[e.id.toString()])||void 0===i?void 0:i.length)>0&&!t[e.id.toString()].every((function(e){return n.find((function(n){return n.id===e}))}))})}))},ce=function(){var e,n=m.Z.useApp().message,t=(0,Q.useModel)("@@initialState").initialState,i=P.useState([]),r=s()(i,2),l=r[0],c=r[1],u=P.useState(),d=s()(u,2),p=d[0],f=d[1],K=P.useState([]),L=s()(K,2),T=L[0],O=L[1],N=P.useState(),q=s()(N,2),A=q[0],_=q[1],F=(0,P.useState)(!1),V=s()(F,2),M=V[0],Y=V[1],W=(0,P.useState)([]),$=s()(W,2),ne=$[0],ie=$[1],ce=(0,P.useState)([]),ue=s()(ce,2),de=ue[0],pe=ue[1],fe=(0,P.useState)([]),he=s()(fe,2),ve=he[0],me=he[1],xe=P.useRef(),ge=function(){var e=o()(a()().mark((function e(n){var t,i,r,o,l,s;return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.applicationId,i=n.roleId,Y(!0),e.next=4,(0,H.a8)({applicationId:t,isRoot:!0});case 4:if(200!==(null==(r=e.sent)?void 0:r.code)){e.next=13;break}if(!i){e.next=12;break}return e.next=9,(0,H.V0)({roleId:i,applicationId:t});case 9:200===(null==(o=e.sent)?void 0:o.code)&&pe((null===(l=o.data)||void 0===l?void 0:l.map((function(e){return e.id})))||[]),r.data&&o.data&&(s=se(r.data,o.data),pe(s.filter((function(e){return!e.isHalf})).map((function(e){return e.id}))));case 12:O(r.data||[]);case 13:Y(!1);case 14:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),ye=(0,v.Z)(H.I7,{onSuccess:function(e){c(e.data||[])}}),je=ye.loading,Ze=ye.refresh,we=(0,v.Z)(H.Jj,{manual:!0,onSuccess:function(e){var n;(f(e.data),e.data&&A)&&(me(null===(n=e.data.members)||void 0===n?void 0:n.map((function(e){return e.serial}))),ge({applicationId:A.id,roleId:e.data.id}))}}),be=we.loading,ke=we.run;return P.useEffect((function(){null!=t&&t.application&&_(null==t?void 0:t.application)}),[null==t?void 0:t.application]),(0,D.jsxs)(G.Z,{activateKey:B.z_.PERMISSION,children:[(0,D.jsxs)(x.Z,{children:[(0,D.jsx)(g.Z,{span:4,style:{paddingRight:6},children:(0,D.jsx)(y.Z,{title:"角色列表",loading:je,styles:{body:{padding:12,height:"83vh",overflowY:"auto"}},extra:(0,D.jsx)(j.Z,{title:"添加角色",children:(0,D.jsx)(Z.ZP,{type:"primary",icon:(0,D.jsx)(ae.Z,{}),onClick:function(){var e,n,i;null===(e=xe.current)||void 0===e||e.callCreateView({params:{organizationId:null==t||null===(n=t.organization)||void 0===n?void 0:n.id,organizationName:null==t||null===(i=t.organization)||void 0===i?void 0:i.name}})}})}),children:(null==l?void 0:l.length)>0?(0,D.jsx)(w.Z,{style:{width:"100%",borderRight:"none"},selectedKeys:p?[p.uuid]:[],mode:"inline",items:null==l?void 0:l.map((function(e){return{key:e.uuid,style:{padding:12},label:(0,D.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,D.jsx)(b.Z.Text,{strong:!0,children:e.name}),(0,D.jsx)(k.Z,{trigger:["click"],menu:{items:[{label:"编辑",key:"edit",icon:(0,D.jsx)(re.Z,{}),onClick:function(n){var t;n.domEvent.stopPropagation(),null===(t=xe.current)||void 0===t||t.callUpdateView({record:e})}},{label:"删除",danger:!0,key:"delete",icon:(0,D.jsx)(oe.Z,{}),onClick:(t=o()(a()().mark((function n(t){var i,r;return a()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.domEvent.stopPropagation(),!e.id){n.next=7;break}return n.next=5,X({id:null===(i=e.id)||void 0===i?void 0:i.toString()});case 5:null!=(r=n.sent)&&r.success&&(Ze(),e.uuid===(null==p?void 0:p.uuid)&&f(void 0));case 7:case"end":return n.stop()}}),n)}))),function(e){return t.apply(this,arguments)})}]},children:(0,D.jsx)(Z.ZP,{size:"small",color:"default",variant:"filled",icon:(0,D.jsx)(le.Z,{style:{fontSize:16}}),onClick:function(e){e.stopPropagation()}})},"options")]}),onClick:(n=o()(a()().mark((function n(){return a()().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:f(e),ke(e.id);case 2:case"end":return n.stop()}}),n)}))),function(){return n.apply(this,arguments)})};var n,t}))}):(0,D.jsx)(S.Z,{image:"https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg",imageStyle:{height:60},description:(0,D.jsx)(b.Z.Text,{strong:!0,children:"还没有角色，请先添加一个吧"}),children:(0,D.jsx)(Z.ZP,{type:"primary",icon:(0,D.jsx)(ae.Z,{}),onClick:function(){var e,n,i;null===(e=xe.current)||void 0===e||e.callCreateView({params:{organizationId:null==t||null===(n=t.organization)||void 0===n?void 0:n.id,organizationName:null==t||null===(i=t.organization)||void 0===i?void 0:i.name}})},children:"添加角色"})})})}),(0,D.jsx)(g.Z,{span:20,children:(0,D.jsx)(y.Z,{title:"关联成员与权限",loading:be,styles:{body:{padding:12,height:"83vh",overflowY:"auto"}},children:p?(0,D.jsx)(D.Fragment,{children:(0,D.jsxs)(C.Z,{column:1,children:[(0,D.jsx)(C.Z.Item,{label:"角色编码",children:(0,D.jsx)(b.Z.Text,{copyable:!0,children:p.alias})}),(0,D.jsx)(C.Z.Item,{label:"关联成员",children:(0,D.jsx)(J,{mode:"multiple",style:{width:360},value:ve,onChange:function(){var e=o()(a()().mark((function e(n,t){return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:me(n||[]),ee({roleId:p.id,members:(null==t?void 0:t.map((function(e){return e.id})))||[]});case 2:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}()})}),(0,D.jsx)(C.Z.Item,{label:"当前应用",children:(0,D.jsx)(I.default,{showSearch:!0,style:{width:360},placeholder:"选择应用",value:null==A?void 0:A.appId,options:null==t||null===(e=t.applications)||void 0===e?void 0:e.map((function(e){return{label:e.name,value:e.appId}})),filterOption:function(e,n){var t,i,a;return null===(t=null!==(i=null==n||null===(a=n.label)||void 0===a?void 0:a.toString())&&void 0!==i?i:"")||void 0===t?void 0:t.toLowerCase().includes(e.toLowerCase())},onChange:function(e){var n,i=null==t||null===(n=t.applications)||void 0===n?void 0:n.find((function(n){return n.appId===e}));_(i),i&&p&&ge({applicationId:i.id,roleId:p.id})}})}),(0,D.jsx)(C.Z.Item,{label:"权限资源",children:(0,D.jsx)(z.Z,{spinning:M,children:(0,D.jsx)(R.Z,{checkable:!0,defaultExpandAll:!0,treeData:T,autoExpandParent:!0,checkedKeys:de,expandedKeys:ne,onExpand:function(e){return ie(e)},titleRender:function(e){return"".concat(e.name,"[").concat(e.alias,"]")},fieldNames:{title:"name",key:"id",children:"children"},onCheck:function(){var e=o()(a()().mark((function e(t,i){var r,o,l;return a()().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=Array.isArray(t)?t:t.checked,o=i.halfCheckedKeys||[],pe(r),!A||!p){e.next=8;break}return e.next=6,te({roleId:p.id,applicationId:A.id,resources:[].concat(h()(r),h()(o))});case 6:null!=(l=e.sent)&&l.success||n.error(l.message||"请求错误");case 8:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}()})})})]})}):(0,D.jsx)(S.Z,{description:"请选择角色"})})})]}),(0,D.jsx)(E.Z,{}),(0,D.jsx)(U.Z,{title:"编辑角色",columns:[{name:"name",dataIndex:"name",title:"角色名称",rules:[{required:!0}]},{name:"alias",dataIndex:"alias",title:"角色别名",rules:[{required:!0}]}],actionRef:xe,path:"api/organizations/role",saveCallback:function(){Ze()}})]})}}}]);